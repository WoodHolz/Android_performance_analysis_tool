# Roadmap: 基于eBPF和Perfetto的Android性能分析工具

## 项目目标

开发一个基于eBPF和Perfetto的Android性能分析工具，用于跟踪和分析Android系统中的线程创建和线程阻塞问题。通过eBPF技术捕获内核和用户态的调用栈信息，并将数据导入Perfetto进行可视化分析，帮助开发者定位性能瓶颈。

### 阶段 1: 环境搭建与需求分析

1. 环境准备

    * 选择运行环境：Android Emulator 或 Cuttlefish。

    * 安装并配置Perfetto工具链，确保能够采集和分析Android系统的性能数据。

    * 配置eBPF开发环境，确保Android内核支持eBPF（GKI内核已默认支持）。

    * 安装libbpf和相关工具链（如bpftool、clang等）。

2. 需求分析

    * 确定需要跟踪的线程创建和线程阻塞的关键点。

    * 确定调用栈的深度要求（至少6级调用栈）。

    * 确定数据展示的维度（频度、数量、调用栈、存活时间、父线程名、应用名等）。

    * 确定Perfetto UI中需要展示的关键指标。

### 阶段 2: eBPF程序开发

1. 线程创建跟踪

    * 编写eBPF程序，跟踪clone、fork等系统调用，捕获线程创建事件。

    * 捕获线程创建时的调用栈信息（用户态和内核态）。

    * 记录线程的创建时间、父线程、进程名、线程名等信息。

    * 将数据通过eBPF map存储，供用户态程序读取。

2. 线程阻塞跟踪

    * 编写eBPF程序，跟踪线程进入D状态（不可中断睡眠状态）的事件。

    * 捕获线程进入D状态时的调用栈信息（用户态和内核态）。

    * 记录线程的阻塞时间、阻塞原因（如IO、低内存等）。

    * 将数据通过eBPF map存储，供用户态程序读取。

3. 符号解析

    * 开发符号解析模块，正确解析Android odex/oat文件中的符号。

    * 确保用户态和内核态调用栈的符号信息能够正确显示。

### 阶段 3: 数据采集与处理

1. 用户态数据采集

    * 开发用户态程序，定期从eBPF map中读取数据。

    * 对数据进行预处理，如调用栈解析、符号化、时间戳转换等。

    * 将处理后的数据写入Perfetto的Trace文件格式。

2. Perfetto数据导入

    * 将处理后的数据导入Perfetto的Trace文件。

    * 确保数据能够与Perfetto的其他事件（如ftrace、atrace等）无缝集成。

### 阶段 4: Perfetto UI集成与可视化

1. 线程创建数据分析

    * 在Perfetto UI中展示线程创建的统计数据，包括：

        * 线程创建频度。

        * 线程存活时间。

        * 父线程名、应用名。

        * 用户态和内核态调用栈。

    * 提供过滤和排序功能，方便开发者定位问题。

2. 线程阻塞数据分析

    * 在Perfetto UI中展示线程阻塞的统计数据，包括：

        * 阻塞线程的调用栈（用户态和内核态）。

        * 阻塞时间。

        * 阻塞原因（如IO、低内存等）。

    * 在时间轴上标记出线程阻塞事件，方便开发者分析卡顿问题。

